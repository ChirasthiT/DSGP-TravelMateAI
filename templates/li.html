<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Identification</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Location Identification</h1>

        <!-- Camera Feed Section -->
        <h2 class="mt-5">Real-Time Camera Feed</h2>
        <div class="text-center">
            <video id="camera" width="320" height="240" autoplay></video>
            <br>
            <button type="button" class="btn btn-primary mt-3" onclick="captureImage()">Capture Image</button>
        </div>

        <!-- Image Upload Section -->
        <h2 class="mt-4">Upload an Image</h2>
        <form id="upload-form" enctype="multipart/form-data">
            <div class="mb-3">
                <input type="file" class="form-control" id="file" name="file" accept="image/*">
            </div>
            <button type="button" class="btn btn-primary" onclick="uploadImage()">Upload and Identify</button>
        </form>
    </div>

    <!-- Modal for Results -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Location Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Modal Content -->
                    <div id="modalResult">
                        <div class="card">
                            <img id="resultImage" src="" class="card-img-top" alt="Location Image">
                            <div class="card-body">
                                <h5 id="resultTitle" class="card-title"></h5>
                                <p id="resultName" class="card-text"></p>
                                <p id="resultHistoricalInfo" class="card-text"></p>
                                <p id="resultFunFacts" class="card-text"></p>
                                <p id="resultNearbyLocations" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('camera');
        const modalResultDiv = document.getElementById('modalResult');

        // Start the camera feed
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing the camera:", err);
                modalResultDiv.innerHTML = `<div class='alert alert-danger'>Error accessing camera: ${err.message}</div>`;
                showModal();
            });

        // Function to handle image capture from the camera
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('file', blob, 'capture.png');
                uploadImage(formData);
            });
        }

        // Function to upload an image (either file input or captured image)
        async function uploadImage(formData = null) {
            if (!formData) {
                const fileInput = document.getElementById('file');
                if (!fileInput.files.length) {
                    modalResultDiv.innerHTML = `<div class='alert alert-warning'>Please select an image to upload.</div>`;
                    showModal();
                    return;
                }
                formData = new FormData(document.getElementById('upload-form'));
            }

            modalResultDiv.innerHTML = "Identifying location...";
            showModal();

            try {
                const response = await fetch('/identify', { method: 'POST', body: formData });
                const result = await response.json();

                if (result.error) {
                    modalResultDiv.innerHTML = `<div class='alert alert-danger'>${result.error}</div>`;
                } else {
                    modalResultDiv.innerHTML = `
                        <div class='card'>
                            <img src='${result.image_url}' class='card-img-top' alt='Location Image'>
                            <div class='card-body'>
                                <h5 class='card-title'>${result.name}</h5>
                                <p class='card-text'>${result.description}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                modalResultDiv.innerHTML = `<div class='alert alert-danger'>Error identifying the location: ${err.message}</div>`;
            }
        }

        // Function to show the modal
        function showModal() {
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
        }

        // Function to upload image and display information in modal
        async function uploadImage(formData = null) {
            if (!formData) {
                const fileInput = document.getElementById('file');
                if (!fileInput.files.length) {
                    showError('Please select an image to upload.');
                    return;
                }
                formData = new FormData(document.getElementById('upload-form'));
            }

            try {
                const response = await fetch('/identify', { method: 'POST', body: formData });
                const result = await response.json();

                if (response.status === 404 || result.error) {
                    showError(result.error || 'Location not found.');
                } else {
                    // Populate modal content dynamically
                    document.getElementById('resultImage').src = result.image_url;
                    document.getElementById('resultTitle').innerText = result.title || 'No Title Available';
                    document.getElementById('resultName').innerHTML = `<strong>Name:</strong> ${result.name}`;
                    document.getElementById('resultHistoricalInfo').innerHTML = `<strong>Historical Info:</strong> ${result.historical_info || 'No information available.'}`;
                    document.getElementById('resultFunFacts').innerHTML = `<strong>Fun Facts:</strong> ${result.fun_facts || 'No fun facts available.'}`;
                    document.getElementById('resultNearbyLocations').innerHTML = `<strong>Nearby Locations:</strong> ${result.nearby_locations || 'No nearby locations available.'}`;

                    // Show modal
                    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                }
            } catch (err) {
                showError('An error occurred while identifying the location.');
            }
        }

        // Helper function to display error messages in modal
        function showError(message) {
            const modalResultDiv = document.getElementById('modalResult');
            modalResultDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
